<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando Login...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .callback-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .loading {
            margin-bottom: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .submessage {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .error {
            color: #e74c3c;
        }

        .success {
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="loading" id="loadingDiv">
            <div class="spinner"></div>
            <div class="message">Processando login...</div>
            <div class="submessage">Por favor, aguarde enquanto validamos suas credenciais.</div>
        </div>
        
        <div id="errorDiv" style="display: none;">
            <div class="message error">Erro no login</div>
            <div class="submessage">Ocorreu um erro ao processar seu login. Tente novamente.</div>
            <button onclick="window.location.href='index.html'" style="margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Tentar Novamente</button>
        </div>
        
        <div id="successDiv" style="display: none;">
            <div class="message success">Login realizado com sucesso!</div>
            <div class="submessage">Redirecionando para a calculadora...</div>
        </div>
    </div>

    <script>
        // Configurações do LinkedIn (mesmas da página de login)
        const LINKEDIN_CLIENT_ID = 'SEU_CLIENT_ID_AQUI';
        const LINKEDIN_CLIENT_SECRET = 'SEU_CLIENT_SECRET_AQUI'; // Em produção, isto deve ficar no backend

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            // Verificar se houve erro na autorização
            if (error) {
                showError('Erro na autorização: ' + error);
                return;
            }

            // Verificar state para prevenir CSRF
            const savedState = localStorage.getItem('linkedin_state');
            if (!state || state !== savedState) {
                showError('Estado inválido. Possível tentativa de CSRF.');
                return;
            }

            // Limpar state do localStorage
            localStorage.removeItem('linkedin_state');

            if (code) {
                // Trocar código por token de acesso
                exchangeCodeForToken(code);
            } else {
                showError('Código de autorização não encontrado.');
            }
        });

        async function exchangeCodeForToken(code) {
            try {
                // ATENÇÃO: Em produção, esta requisição deve ser feita pelo backend
                // para manter o client_secret seguro
                const tokenResponse = await fetch('https://www.linkedin.com/oauth/v2/accessToken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: window.location.origin + '/callback.html',
                        client_id: LINKEDIN_CLIENT_ID,
                        client_secret: LINKEDIN_CLIENT_SECRET
                    })
                });

                if (!tokenResponse.ok) {
                    throw new Error('Erro ao obter token de acesso');
                }

                const tokenData = await tokenResponse.json();
                const accessToken = tokenData.access_token;

                // Salvar token no localStorage
                localStorage.setItem('linkedin_access_token', accessToken);

                // Obter dados do perfil do usuário
                await getUserProfile(accessToken);

                // Mostrar sucesso e redirecionar
                showSuccess();
                setTimeout(() => {
                    window.location.href = 'calculator.html';
                }, 2000);

            } catch (error) {
                console.error('Erro no processo de autenticação:', error);
                showError('Erro ao processar autenticação.');
            }
        }

        async function getUserProfile(accessToken) {
            try {
                // Obter dados básicos do perfil
                const profileResponse = await fetch('https://api.linkedin.com/v2/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                // Obter email
                const emailResponse = await fetch('https://api.linkedin.com/v2/emailAddress?q=members&projection=(elements*(handle~))', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (profileResponse.ok && emailResponse.ok) {
                    const profileData = await profileResponse.json();
                    const emailData = await emailResponse.json();

                    const userProfile = {
                        id: profileData.id,
                        firstName: profileData.localizedFirstName,
                        lastName: profileData.localizedLastName,
                        email: emailData.elements[0]['handle~'].emailAddress,
                        profilePicture: profileData.profilePicture ? profileData.profilePicture['displayImage~'].elements[0].identifiers[0].identifier : null
                    };

                    // Salvar dados do usuário
                    localStorage.setItem('user_profile', JSON.stringify(userProfile));
                }
            } catch (error) {
                console.error('Erro ao obter dados do perfil:', error);
                // Continuar mesmo se não conseguir obter o perfil
            }
        }

        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'block';
            document.querySelector('#errorDiv .submessage').textContent = message;
        }

        function showSuccess() {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('successDiv').style.display = 'block';
        }
    </script>
</body>
</html>